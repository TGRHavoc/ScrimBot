/*! ScrimBot - v0.0.1 - 2016-03-06\n* Copyright (c) 2016 Jordan Dalton; Licensed  */var ytdl=require("ytdl-core");Track=function(a,b){this.vid=a,this.title=b.title,this.author=b.author,this.viewCount=b.viewCount||b.view_count,this.lengthSeconds=b.lengthSeconds||b.length_seconds},Track.prototype.formatViewCount=function(){return this.viewCount?this.viewCount.replace(/\B(?=(\d{3})+(?!\d))/g,","):"unknown"},Track.prototype.formatTime=function(){return formatTime(this.lengthSeconds)},Track.prototype.prettyPrint=function(){return"**"+this.title+"** by **"+this.author+"** *("+this.formatViewCount()+" views)* ["+this.formatTime()+"]"},Track.prototype.fullPrint=function(){return this.prettyPrint()+", added by <@"+this.userId+">"},Track.prototype.saveable=function(){return{vid:this.vid,title:this.title,author:this.author,viewCount:this.viewCount,lengthSeconds:this.lengthSeconds}},Track.prototype.getTime=function(){return this.lengthSeconds},YoutubeTrack=function(){Track.apply(this,arguments)},YoutubeTrack.prototype=Object.create(Track.prototype),YoutubeTrack.getInfoFromVid=function(a,b,c){var d="http://www.youtube.com/watch?v="+a;ytdl.getInfo(d,function(d,e){if(d)c(d,void 0);else{var f=new YoutubeTrack(a,e);f.userId=b.author.id,f.containedVideo=e,c(void 0,f)}})},YoutubeTrack.prototype.getStream=function(){var a={filter:function(a){"mp4"===a.container},quality:"lowest"};return ytdl.downloadFromInfo(this.containedVideo,a)};var playCommand={usage:"[youtube video id]",description:"Play a YouTube video's audio",permission:function(a){a.author,a.channel.server;return!0},process:function(a,b,c){return c=c.split(" "),c[0]?a.voiceConnection?void YoutubeTrack.getInfoFromVid(c[0],b,function(c,d){if(c)return console.log("Play error: "+c),void a.sendMessage(b,"Error playing video:"+c);currentlyPlayingSong=d;var e=d.getStream();e.on("end",setTimeout(function(){a.voiceConnection&&a.voiceConnection.stopPlaying(),a.sendMessage(b,"Finished playing **"+d.title+"**"),a.setStatus("online",null),currentlyPlayingSong=null},4e3)),a.voiceConnection.playRawStream(e,function(c,e){a.sendMessage(b,d.prettyPrint()),a.setStatus("online",d.author)})}):void a.sendMessage(b,"I'm not in a voice channel. Please use the join command first!"):void a.sendMessage(b,"Please specify a YouTube video ID. E.g. PivWY9wn5ps")}};module.exports=playCommand;
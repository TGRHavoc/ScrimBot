/*! ScrimBot - v0.0.1 - 2016-03-06\n* Copyright (c) 2016 Jordan Dalton; Licensed  */function loadCommands(a){var b=require("fs");b.readdirSync(a).forEach(function(c){var d=a+c;if(b.statSync(d).isDirectory())loadCommands(d+"/");else if("js"==c.split(".").pop()){var e=c.split(".")[c.split(".").length-2];if(e in commands)return void console.log("Error, command '"+e+"' already exists");commands[e]=require(d),commands[e].i=currentIndexOfCommand++,commands[e].init&&"function"==typeof commands[e].init&&commands[e].init()}})}function exitHandler(a,b){b&&console.log("Not clean"+b.stack),a.exit&&(console.log("Saving data to files..."),fileUtils.fileExists("lib/data/assosiations.json")||(fileUtils.dirExists("lib/data")||fileUtils.makeDir("lib/data"),fileUtils.createFile("lib/data/assosiations.json")),fileUtils.fileExists("lib/data/data.json")||(fileUtils.dirExists("lib/data")||fileUtils.makeDir("lib/data"),fileUtils.createFile("lib/data/data.json")),fileUtils.writeFileSync("lib/data/assosiations.json",Assosiations,{options:{spaces:4}}),fileUtils.writeFileSync("lib/data/data.json",McData,{options:{spaces:4}}),console.log("Written all data to files... Now exiting."),process.exit())}function sendPagedHelp(a,b,arguments){var c=arguments.split(" "),d=1;if(c[0]){if(isNaN(c[0]))return void a.sendMessage(b.channel,"Sorry, '"+c[0]+"' isn't a number!");d=parseInt(c[0])}var e=Math.floor((Object.size(commands)-1)/config.help.messages_per_page+1);if(start=(d-1)*config.help.messages_per_page,end=start+config.help.messages_per_page,!(d>0&&e>=d))return void a.sendMessage(b.channel,"Sorry that page doesn't exist!");var f="**Available commands ( page _"+d+"_ of _"+e+"_ ):**";a.sendMessage(b.channel,f,function(){for(cmd in commands)if(commands[cmd].i>=start&&commands[cmd].i<end){var c="**"+cmd+"**",d=commands[cmd].usage;d&&""!=d&&(c+=" *"+d+"*");var e=commands[cmd].description;c+=e&&""!=e?"\n	"+e:"\n	No description for this command found.",a.sendMessage(b.channel,c)}})}function sendHelpDm(a,b){var c="**Available commands** \n",d=c;for(cmd in commands){var e="**"+cmd+"**";if(!commands[cmd].permission||"function"!=typeof commands[cmd].permission||commands[cmd].permission(b)){var f=commands[cmd].usage;f&&""!=f&&(e+=" *"+f+"*");var g=commands[cmd].description;e+=g&&""!=g?"\n	"+g:"\n	No description for this command found.",d+=e+"\n"}}a.sendMessage(b.author,d),a.sendMessage(b,"I have sent my commands to you via DM")}var commands={},config=require("./lib/config"),Discord=require("discord.js"),mcProto=require("minecraft-protocol"),fileUtils=require("./lib/utils/fileUtils");authServer=mcProto.createServer({"online-mode":!0,motd:"ScrimBots' Authentication Server","max-players":1}),Assosiations=[],McData=[],Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c};var currentIndexOfCommand=0,bot=new Discord.Client;bot.on("ready",function(){loadCommands("./lib/commands/"),console.log("\nReady to serve! Currently "+bot.channels.length+" channels!"),fileUtils.fileExists("lib/data/assosiations.json")&&fileUtils.readFile("lib/data/assosiations.json",function(a,b){return a?void console.log("Error reading: "+a.message):void(Assosiations=b)}),fileUtils.fileExists("lib/data/data.json")&&fileUtils.readFile("lib/data/data.json",function(a,b){return a?void console.log("Error reading: "+a.message):void(McData=b)})}),bot.on("disconnected",function(){console.log("I've been disconnected!!!"),authServer.close(),exitHandler({exit:!0},null)}),process.on("exit",exitHandler.bind(null,{clean:!0})),process.on("SIGINT",exitHandler.bind(null,{exit:!0})),process.on("uncaughtException",exitHandler.bind(null,{exit:!0})),bot.on("message",function(a){if(a.author.id!=bot.user.id&&("!"===a.content[0]||"/"===a.content[0]||0==a.content.indexOf(bot.user.mention()))){console.log("Treating message from "+a.author+"("+a.author.name+") as command");var b=a.content.split(" ")[0].substring(1),arguments=a.content.substring(b.length+2);if(0==a.content.indexOf(bot.user.mention()))try{b=a.content.split(" ")[1],arguments=a.content.substring(bot.user.mention().length+b.length+2)}catch(c){return void bot.sendMessage(a.channel,"Yes?")}b=b.toLowerCase();var d=commands[b];if("help"===b)return void(config.help.send_dm?sendHelpDm(bot,a):sendPagedHelp(bot,a,arguments));if(d){if(b in commands)try{if(commands[b].permission&&"function"==typeof commands[b].permission&&!commands[b].permission(a))return void bot.sendMessage(a,"Sorry, you don't have permission to run this command.");commands[b].process(bot,a,arguments)}catch(c){bot.sendMessage(a,"Error occured when executing command '"+b+"': "+c.stack)}}else{if(a.author==bot.user)return;bot.sendMessage(a.channel,"Sorry, that command doesn't exist")}}}),bot.login(config.auth.email,config.auth.password);